name: Cross-Language Codegen

on:
  push:
    branches: [main]
    paths:
      - 'src/main/java/aster/core/lexicon/**'
      - 'src/main/java/aster/core/identifier/**'
      - 'src/main/resources/**'

concurrency:
  group: codegen-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codegen:
    runs-on: ubuntu-latest
    steps:
      # Checkout 所有仓库到工作区子目录
      - uses: actions/checkout@v4
        with:
          path: aster-lang-core

      - uses: actions/checkout@v4
        with:
          repository: aster-cloud/aster-lang-en
          path: aster-lang-en
          token: ${{ secrets.CROSS_REPO_TOKEN }}

      - uses: actions/checkout@v4
        with:
          repository: aster-cloud/aster-lang-zh
          path: aster-lang-zh
          token: ${{ secrets.CROSS_REPO_TOKEN }}

      - uses: actions/checkout@v4
        with:
          repository: aster-cloud/aster-lang-de
          path: aster-lang-de
          token: ${{ secrets.CROSS_REPO_TOKEN }}

      - uses: actions/checkout@v4
        with:
          repository: aster-cloud/aster-lang-ts
          path: aster-lang-ts
          token: ${{ secrets.CROSS_REPO_TOKEN }}

      - uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: 'gradle'

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'
          cache-dependency-path: 'aster-lang-ts/pnpm-lock.yaml'

      # Phase 1: 编译 core + lang packs
      - name: Build core & lang packs
        run: |
          cd aster-lang-core && ./gradlew compileJava publishToMavenLocal -x test && cd ..
          cd aster-lang-en && ./gradlew publishToMavenLocal -x test && cd ..
          cd aster-lang-zh && ./gradlew publishToMavenLocal -x test && cd ..
          cd aster-lang-de && ./gradlew publishToMavenLocal -x test && cd ..

      # Phase 2: 导出 JSON
      - name: Export lexicons & vocabularies
        working-directory: aster-lang-core
        run: ./gradlew exportLexicons exportVocabularies

      # Phase 3: 生成 TS 代码
      - name: Generate TypeScript code
        working-directory: aster-lang-ts
        run: |
          pnpm install --frozen-lockfile
          pnpm run generate:lexicons -- ../aster-lang-core/build/generated/lexicons/lexicons.json
          pnpm run generate:vocabularies -- ../aster-lang-core/build/generated/vocabularies/vocabularies.json

      # Phase 4: 检测变更并提 PR
      - name: Create PR if changed
        working-directory: aster-lang-ts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git checkout -b codegen/update-from-java
            git add -A
            git commit -m "chore(codegen): sync Java lexicon/vocabulary updates"
            git push -f origin codegen/update-from-java
            gh pr create \
              --title "chore(codegen): sync Java updates" \
              --body "Automatically generated by aster-lang-core codegen workflow." \
              --base main || true
          fi
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
